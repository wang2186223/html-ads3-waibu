# 每日独立表格统计系统 - 使用指南

## 📋 概述

这是一个改进版的 Google Sheets 统计系统，解决了**单表格容量限制问题**。

### 核心改进
- ❌ **旧方案**：一个主表格 + 每天创建新 sheet（容易超出 500 万单元格限制）
- ✅ **新方案**：一个主表格（控制台） + 每天创建独立的新表格（无容量限制）

---

## 🏗️ 架构设计

```
主表格 (ID: 1kEvOkFHVQ92HK0y7I1-8qEjfzYrwt0DFQWEiVNTqXS4)
├── 📊总控制台          // 汇总所有数据的总体统计
├── 📑表格索引          // 记录所有每日表格的链接和ID
└── 其他配置 sheet

Google Drive 文件夹: "网站统计数据"
├── ads-recan-2025-01-15  // 每日独立表格
│   ├── 📊当日统计       // 当天的数据概览
│   ├── 页面访问         // 详细的访问记录
│   └── 广告引导         // 广告引导触发记录
├── ads-recan-2025-01-16
├── ads-recan-2025-01-17
└── ...
```

---

## 📦 部署步骤

### 1. 替换 Google Apps Script 代码

1. 打开 Google Apps Script 编辑器
2. **完整替换**现有代码为 `analytics-script-daily-spreadsheets.js`
3. 保存并部署

### 2. 配置常量（如需修改）

```javascript
const MAIN_SPREADSHEET_ID = '1kEvOkFHVQ92HK0y7I1-8qEjfzYrwt0DFQWEiVNTqXS4';  // 主表格ID
const DATA_FOLDER_NAME = '网站统计数据';  // Google Drive 文件夹名称
const SPREADSHEET_PREFIX = 'ads-recan-';    // 每日表格命名前缀
```

### 3. 设置触发器

#### 必须设置的触发器：

| 函数名称 | 触发类型 | 频率 | 说明 |
|---------|---------|------|------|
| `sendDailyReport` | 时间驱动 | 每天 01:00-02:00 | 发送每日统计邮件 |
| `updateMainDashboard` | 时间驱动 | 每小时 | 更新主控制台统计 |

#### 可选触发器：

| 函数名称 | 触发类型 | 频率 | 说明 |
|---------|---------|------|------|
| `cleanupOldSpreadsheets` | 时间驱动 | 每周一次 | 清理30天前的旧表格 |

**设置方法：**
1. 在 Apps Script 编辑器中点击左侧"触发器"（闹钟图标）
2. 点击"添加触发器"
3. 选择对应的函数和时间
4. 保存

---

## 🎯 核心功能说明

### 1. 自动创建每日表格

**触发条件**：首次接收到当天的数据请求

**执行流程**：
1. 检查主表格的"📑表格索引"中是否有今日表格记录
2. 检查 Google Drive "网站统计数据"文件夹中是否存在
3. 如不存在，自动创建新表格并初始化结构
4. 将表格信息添加到索引

**表格结构**：
```
ads-recan-2025-01-15
├── 📊当日统计
│   ├── 页面访问次数
│   ├── 广告引导触发
│   ├── 独立IP数量
│   └── 最后更新时间
├── 页面访问
│   └── [时间, 访问页面, 用户属性, IP地址]
└── 广告引导
    └── [时间, 访问页面, 用户属性, IP地址, 累计广告数, 当前页广告数, 触发次数, 最大触发次数, 事件时间戳]
```

### 2. 数据写入逻辑

**页面访问事件**：
- 自动写入到当日表格的"页面访问" sheet
- 5% 概率触发当日统计更新

**广告引导事件**：
- 自动写入到当日表格的"广告引导" sheet
- 不影响页面访问统计

### 3. 统计更新机制

**每日统计**（在每日表格中）：
- 页面访问次数
- 广告引导触发次数
- 独立IP数量（自动去重）

**总控制台**（在主表格中）：
- 今日访问量
- 总访问量（所有表格汇总）
- 总广告引导次数
- 活跃天数
- 平均日访问量

**更新频率**：
- 每日统计：5% 概率实时更新
- 总控制台：1% 概率实时更新 + 每小时触发器

### 4. 每日邮件报告

**发送时间**：每天北京时间 01:00  
**收件人**：`jannatjahan36487@gmail.com`

**邮件内容**：
- 前一天的详细统计数据
- 总体累计数据
- Excel 格式附件（包含完整的前一天数据）

### 5. 数据清理

**手动触发**：`manualCleanup()`  
**自动触发**：设置每周触发器（可选）

**清理规则**：
- 默认保留最近 30 天的数据
- 超过 30 天的表格移到回收站
- 同时从索引中删除记录

**修改保留天数**：
```javascript
cleanupOldSpreadsheets(60); // 保留60天
```

---

## 🧪 测试函数

在部署前和部署后，可以运行这些测试函数验证系统是否正常：

### 1. 测试创建每日表格
```javascript
testCreateDailySpreadsheet()
```
**期望结果**：
- 在 Google Drive 创建新表格
- 主表格的"📑表格索引"中添加记录
- 返回新表格的 URL

### 2. 测试页面访问数据
```javascript
testPageVisit()
```
**期望结果**：
- 在今日表格的"页面访问" sheet 中添加一条测试记录

### 3. 测试广告引导数据
```javascript
testAdGuide()
```
**期望结果**：
- 在今日表格的"广告引导" sheet 中添加一条测试记录

### 4. 测试主控制台更新
```javascript
manualUpdateDashboard()
```
**期望结果**：
- 主表格的"📊总控制台" sheet 显示最新的汇总统计

### 5. 测试邮件发送
```javascript
testEmailReport()
```
**期望结果**：
- 收到一封包含统计数据和 Excel 附件的邮件

---

## 📊 主表格 Sheet 说明

### 📊总控制台
- 显示所有表格的汇总统计
- 包括今日、总计、平均等指标
- 每小时自动更新

### 📑表格索引
- 记录所有每日表格的元数据
- 列：日期 | 表格ID | 表格链接 | 创建时间
- 用于快速查找和跨表格统计

---

## 🔧 常见问题

### Q1: 如何查看某一天的详细数据？
**A**: 
1. 打开主表格
2. 进入"📑表格索引" sheet
3. 找到对应日期，点击"表格链接"列的链接

### Q2: 旧数据会自动删除吗？
**A**: 
- 不会自动删除（除非设置了清理触发器）
- 建议每月手动运行 `manualCleanup()` 清理旧数据
- 或设置每周触发器自动清理

### Q3: 如何修改邮件收件人？
**A**: 在 `sendDailyReport()` 函数中修改：
```javascript
const recipientEmail = '你的邮箱@example.com';
```

### Q4: 数据写入失败怎么办？
**A**: 检查以下几点：
1. 主表格 ID 是否正确
2. Google Drive 是否有足够的存储空间
3. Apps Script 是否有权限访问 Drive
4. 查看执行日志中的错误信息

### Q5: 如何手动创建今天的表格？
**A**: 运行测试函数：
```javascript
testCreateDailySpreadsheet()
```

### Q6: 总控制台数据不准确？
**A**: 手动触发更新：
```javascript
manualUpdateDashboard()
```

### Q7: 每日表格占用太多空间？
**A**: 
- 定期运行清理函数：`cleanupOldSpreadsheets(30)`
- 或直接在 Google Drive 中删除不需要的表格
- 记得同时从索引中删除对应记录

---

## 📈 性能优化建议

### 1. 控制更新频率
- 当日统计：5% 概率（高频访问时降低到 1-2%）
- 总控制台：1% 概率 + 每小时触发器（足够了）

### 2. 索引维护
- 定期检查索引中的失效链接
- 删除已归档/删除的表格记录

### 3. 数据清理策略
- 高频网站：保留 15-30 天
- 中频网站：保留 30-60 天
- 低频网站：保留 60-90 天

### 4. 邮件附件优化
- 如果单日数据量超大（>10万行），考虑只发送统计概览
- 或将详细数据分Sheet发送

---

## 🚀 迁移指南（从旧版本升级）

### 步骤 1: 备份现有数据
1. 复制当前主表格
2. 保存所有重要的统计 sheet

### 步骤 2: 部署新代码
1. 完整替换 Apps Script 代码
2. 保持主表格 ID 不变

### 步骤 3: 初始化新结构
1. 运行 `testCreateDailySpreadsheet()` 创建今日表格
2. 运行 `manualUpdateDashboard()` 初始化总控制台

### 步骤 4: 历史数据迁移（可选）
如果需要保留历史数据：
1. 在新的每日表格中手动导入历史 sheet 的数据
2. 或创建一个"历史归档"表格存放旧数据

### 步骤 5: 设置触发器
按照上面的触发器设置说明配置

### 步骤 6: 测试验证
运行所有测试函数确保系统正常工作

---

## 🎯 优势总结

### ✅ 解决的问题
1. **容量限制**：单表格 500 万单元格限制 → 无限制
2. **性能问题**：表格过大导致加载慢 → 每日独立，加载快
3. **数据管理**：难以归档和清理 → 按日期独立管理

### ✅ 新增功能
1. **自动索引**：主表格自动维护所有子表格的索引
2. **快速定位**：通过索引快速找到任意日期的数据
3. **灵活清理**：可按需删除旧数据，不影响总体结构
4. **独立统计**：每个表格有自己的统计概览

### ✅ 保留功能
1. 页面访问统计
2. 广告引导统计
3. 每日邮件报告
4. Excel 附件导出

---

## 📞 技术支持

如有问题或需要定制功能，请参考代码注释或联系开发者。

**代码文件**：`analytics-script-daily-spreadsheets.js`  
**版本**：2.0 - Daily Spreadsheets Edition  
**更新日期**：2025-01-15
